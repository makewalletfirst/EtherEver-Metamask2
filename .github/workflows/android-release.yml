name: Android Release Build

on:
  workflow_dispatch: # 수동 실행 버튼 활성화
  push:
    branches: [ "main" ] # main 브랜치 푸시 시 자동 실행 (테스트 편의성)
    tags:
      - 'v*'

jobs:
  android-build:
    name: Build Android Release
    runs-on: ubuntu-latest

    steps:
  - name: Checkout Repository
    uses: actions/checkout@v4

  - name: Setup Java (JDK 17)
    uses: actions/setup-java@v4
    with:
      distribution: 'zulu'
      java-version: '17'

  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      # 프로젝트의 .nvmrc 버전을 따릅니다.
      node-version-file: '.nvmrc'
      cache: 'yarn'

  - name: Install Dependencies
    run: yarn install --frozen-lockfile

  # [수정됨] 두 개의 라이브러리 파일에서 'compile' 키워드를 'implementation'으로 수정합니다.
  - name: Fix Deprecated Gradle Syntax
    run: |
      # 1. react-native-aes-crypto-forked 수정
      FILE_PATH_CRYPTO=node_modules/react-native-aes-crypto-forked/android/build.gradle
      sed -i 's/compile /implementation /g' $FILE_PATH_CRYPTO
      echo "Fixed deprecated 'compile' in $FILE_PATH_CRYPTO"

      # 2. react-native-i18n 수정 (새로 추가됨)
      FILE_PATH_I18N=node_modules/react-native-i18n/android/build.gradle
      sed -i 's/compile /implementation /g' $FILE_PATH_I18N
      echo "Fixed deprecated 'compile' in $FILE_PATH_I18N"


  # MetaMask 빌드에 필요한 환경 설정 파일들을 복사합니다.
  - name: Create Config Files
    run: |
      echo "Copying .js.env..."
      cp .js.env.example .js.env
      
      echo "Copying google-services.json..."
      cp android/app/google-services-example.json android/app/google-services.json

  # Github Secrets에 저장된 Base64 Keystore를 파일로 복원합니다.
  - name: Decode Keystore
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
    run: |
      echo $ANDROID_KEYSTORE_BASE64 | base64 --decode > android/app/release.keystore

  # Gradle 빌드를 실행합니다.
  - name: Build Release APK
    working-directory: android # <-- 작업 디렉토리를 android로 설정
    env:
      # Keystore 관련 Secrets를 환경변수로 주입
      MYAPP_UPLOAD_STORE_FILE: release.keystore
      MYAPP_UPLOAD_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      MYAPP_UPLOAD_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      MYAPP_UPLOAD_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    run: |
      chmod +x gradlew
      # 빌드 및 상세 디버그 출력을 위한 --stacktrace 플래그 추가
      ./gradlew assembleRelease --no-daemon --stacktrace

  # 빌드된 APK 파일을 Artifact로 저장하여 다운로드할 수 있게 합니다.
  - name: Upload APK Artifact
    uses: actions/upload-artifact@v4
    with:
      name: app-release
      path: android/app/build/outputs/apk/release/app-release.apk
      retention-days: 3
