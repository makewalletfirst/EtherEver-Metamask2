name: Android Release Build

on:
  workflow_dispatch: # 수동 실행 버튼 활성화
  push:
    branches: [ "main" ] # main 브랜치 푸시 시 자동 실행 (테스트 편의성)
    tags:
      - 'v*'

jobs:
  android-build:
    name: Build Android Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile
        
      # [추가된 부분] 구식 'compile' 키워드를 'implementation'으로 대체
      - name: Fix Deprecated Gradle Syntax
        run: |
          # 1. aes-crypto 라이브러리 내의 build.gradle 파일 경로 설정
          FILE_PATH=node_modules/react-native-aes-crypto-forked/android/build.gradle
          
          # 2. 'compile ' 키워드를 'implementation ' 으로 대체
          # 이 명령어는 해당 파일 내의 모든 'compile '을 'implementation '으로 변경합니다.
          sed -i 's/compile /implementation /g' $FILE_PATH
          
          echo "Fixed deprecated 'compile' syntax in $FILE_PATH"
          
      # [수정됨] 사용자가 지적한 환경 설정 파일 및 구글 서비스 파일 복사
      - name: Create Config Files
        run: |
          echo "Copying .js.env..."
          cp .js.env.example .js.env
          
          echo "Copying google-services.json..."
          cp android/app/google-services-example.json android/app/google-services.json

      # Keystore 파일 복원
      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo $ANDROID_KEYSTORE_BASE64 | base64 --decode > android/app/release.keystore

      # Gradle 빌드 실행
      - name: Build Release APK
        working-directory: android
        env:
          MYAPP_UPLOAD_STORE_FILE: release.keystore
          MYAPP_UPLOAD_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          MYAPP_UPLOAD_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_UPLOAD_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          chmod +x gradlew
          # [수정됨] --stacktrace 플래그 추가
          ./gradlew assembleRelease --no-daemon --stacktrace

      # 결과물 업로드
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 3
