name: Android Release Build

on:
workflow_dispatch: # 수동 실행 버튼 활성화
push:
branches: [ "main" ] # main 브랜치 푸시 시 자동 실행 (테스트 용이성)
tags:
- 'v*' # v1.0.0 등의 태그가 푸시될 때 실행

jobs:
android-build:
name: Build Android Release
runs-on: ubuntu-latest

steps:
  - name: Checkout Repository
    uses: actions/checkout@v4

  - name: Setup Java (JDK 17)
    uses: actions/setup-java@v4
    with:
      distribution: 'zulu'
      java-version: '17'

  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      # 프로젝트의 .nvmrc 버전을 따릅니다.
      node-version-file: '.nvmrc'
      cache: 'yarn'

  - name: Install Dependencies
    run: yarn install --frozen-lockfile

  # 1. 의존성 내 구식 Gradle 문법 (compile)을 implementation으로 수정합니다.
  - name: Fix Deprecated Gradle Syntax
    run: |
      FILE_PATH=node_modules/react-native-aes-crypto-forked/android/build.gradle
      # sed 명령어를 사용하여 'compile ' 문자열을 'implementation '으로 일괄 변경합니다.
      sed -i 's/compile /implementation /g' $FILE_PATH
      echo "Fixed deprecated 'compile' syntax in $FILE_PATH"

  # 2. MetaMask 빌드에 필요한 환경 설정 파일들을 복사합니다.
  - name: Create Config Files
    run: |
      echo "Copying .js.env..."
      cp .js.env.example .js.env
      
      echo "Copying google-services.json..."
      cp android/app/google-services-example.json android/app/google-services.json

  # 3. Github Secrets에 저장된 Base64 Keystore를 파일로 복원합니다.
  - name: Decode Keystore
    env:
      ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
    run: |
      echo $ANDROID_KEYSTORE_BASE64 | base64 --decode > android/app/release.keystore

  # 4. Gradle 빌드를 실행합니다. (working-directory로 경로 설정)
  - name: Build Release APK
    working-directory: android # <-- 작업 디렉토리를 android로 설정
    env:
      # Keystore 관련 Secrets를 환경변수로 주입 (android/app/build.gradle이 읽어들임)
      MYAPP_UPLOAD_STORE_FILE: release.keystore
      MYAPP_UPLOAD_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
      MYAPP_UPLOAD_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      MYAPP_UPLOAD_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
    run: |
      chmod +x gradlew
      # 빌드 및 상세 디버그 출력을 위한 --stacktrace 플래그 추가
      ./gradlew assembleRelease --no-daemon --stacktrace

  # 5. 빌드된 APK 파일을 Artifact로 저장하여 다운로드할 수 있게 합니다.
  - name: Upload APK Artifact
    uses: actions/upload-artifact@v4
    with:
      name: app-release
      path: android/app/build/outputs/apk/release/app-release.apk
      retention-days: 3
