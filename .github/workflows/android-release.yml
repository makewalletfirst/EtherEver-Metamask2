name: Android Release Build

on:
  workflow_dispatch: # 수동으로 실행 가능하도록 설정
  push:
    tags:
      - 'v*' # v1.0.0 등의 태그가 푸시될 때 실행

jobs:
  android-build:
    name: Build Android Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17' # 최신 RN 및 MetaMask는 JDK 17 권장

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc' # 프로젝트의 .nvmrc 버전을 따름 (없으면 '18'로 수정)
          cache: 'yarn'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      # 환경 변수 설정 (MetaMask 빌드에 필요한 .env 생성)
      - name: Create .env file
        run: |
          cp .env.example .env
          # 필요한 경우 여기에 echo "ENV_VAR=value" >> .env 추가

      # Keystore 파일 복원 (Secrets에서 디코딩)
      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo $ANDROID_KEYSTORE_BASE64 | base64 --decode > android/app/release.keystore

      # Gradle 빌드 실행 (APK 생성)
      - name: Build Release APK
        cd android
        env:
          MYAPP_UPLOAD_STORE_FILE: release.keystore
          MYAPP_UPLOAD_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          MYAPP_UPLOAD_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_UPLOAD_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon

      # 빌드된 APK를 Artifact로 업로드 (다운로드 가능하게 함)
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 3
